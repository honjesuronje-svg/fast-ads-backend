# Upstream for Laravel API
upstream laravel_api {
    least_conn;
    server laravel-api:8000 max_fails=3 fail_timeout=30s;
    # Add more instances for scaling:
    # server laravel-api-2:8000 max_fails=3 fail_timeout=30s;
}

# Upstream for Golang SSAI Service
upstream golang_ssai {
    least_conn;
    server golang-ssai:8080 max_fails=3 fail_timeout=30s;
    # Add more instances for scaling:
    # server golang-ssai-2:8080 max_fails=3 fail_timeout=30s;
}

# Laravel API endpoints
server {
    listen 80;
    server_name api.fastads.local;

    client_max_body_size 10M;

    location / {
        limit_req zone=api_limit burst=20 nodelay;
        
        proxy_pass http://laravel_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}

# Golang SSAI Service endpoints
server {
    listen 80;
    server_name ssai.fastads.local;

    # HLS manifest caching
    location ~* \.m3u8$ {
        limit_req zone=ssai_limit burst=100 nodelay;
        
        proxy_pass http://golang_ssai;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-IPCountry $http_cf_ipcountry; # Cloudflare geo header
        
        # Cache manifests for 10 seconds
        proxy_cache_valid 200 10s;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        
        add_header Cache-Control "public, max-age=10";
        add_header X-Cache-Status $upstream_cache_status;
    }

    # HLS segment requests
    location ~* \.ts$ {
        limit_req zone=ssai_limit burst=200 nodelay;
        
        proxy_pass http://golang_ssai;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Cache segments for 1 hour
        proxy_cache_valid 200 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # Tracking endpoints
    location /tracking/ {
        limit_req zone=ssai_limit burst=500 nodelay;
        
        proxy_pass http://golang_ssai;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Health check
    location /health {
        proxy_pass http://golang_ssai;
        access_log off;
    }
}

# Default server (redirect to API)
server {
    listen 80 default_server;
    server_name _;
    return 301 http://api.fastads.local$request_uri;
}

